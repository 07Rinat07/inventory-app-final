{% block javascripts %}
  {{ parent() }}

  <script>
    const tbody = document.getElementById('fields-sortable');
    const saveButton = document.getElementById('save-order-btn');

    if (!tbody || !saveButton) {
      console.warn('Reorder UI not initialized: missing elements');
      return;
    }

    let draggedRow = null;

    // Сделать строки draggable
    tbody.querySelectorAll('tr').forEach(row => {
      row.setAttribute('draggable', 'true');
    });

    // ---------------- Drag & Drop ----------------

    tbody.addEventListener('dragstart', event => {
      draggedRow = event.target.closest('tr');
      if (!draggedRow) return;

      draggedRow.classList.add('table-active');
      event.dataTransfer.effectAllowed = 'move';
    });

    tbody.addEventListener('dragend', () => {
      if (draggedRow) {
        draggedRow.classList.remove('table-active');
        draggedRow = null;
      }
    });

    tbody.addEventListener('dragover', event => {
      event.preventDefault();

      const targetRow = event.target.closest('tr');
      if (!targetRow || targetRow === draggedRow) return;

      const rect = targetRow.getBoundingClientRect();
      const shouldInsertAfter =
        (event.clientY - rect.top) / rect.height > 0.5;

      tbody.insertBefore(
        draggedRow,
        shouldInsertAfter ? targetRow.nextSibling : targetRow
      );

      // Активируем кнопку при изменении порядка
      saveButton.disabled = false;
      saveButton.classList.remove('btn-success');
      saveButton.classList.add('btn-primary');
      saveButton.textContent = 'Save order';
    });

    // ---------------- Save order ----------------

    saveButton.addEventListener('click', async () => {
      const order = Array.from(
        tbody.querySelectorAll('tr')
      ).map(row => row.dataset.id);

      try {
        const response = await fetch(
          '{{ path('inventory_custom_fields_reorder', { id: inventory.id }) }}',
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ order })
          }
        );

        if (!response.ok) {
          throw new Error('Server error');
        }

        saveButton.classList.remove('btn-primary');
        saveButton.classList.add('btn-success');
        saveButton.textContent = 'Saved';
        saveButton.disabled = true;

      } catch (e) {
        alert('Failed to save order');
        console.error(e);
      }
    });
  </script>
{% endblock %}

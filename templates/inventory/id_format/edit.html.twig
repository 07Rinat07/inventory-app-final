{% extends 'base.html.twig' %}

{% block body %}
  <div class="container mt-4">

    <h3>Custom ID format</h3>

    <form method="post">
      <table class="table table-bordered">
        <thead>
        <tr>
          <th></th>
          <th>Type</th>
          <th>Param 1</th>
          <th>Param 2</th>
        </tr>
        </thead>

        <tbody id="format-parts">
        {% for part in format.getParts %}
          <tr draggable="true" data-index="{{ loop.index0 }}">
            <td class="text-muted">â˜°</td>
            <td>
              {{ part.type }}
              <input type="hidden" name="parts[{{ loop.index0 }}][type]" value="{{ part.type }}">
            </td>
            <td>
              {{ part.param1 }}
              <input type="hidden" name="parts[{{ loop.index0 }}][param1]" value="{{ part.param1 }}">
            </td>
            <td>
              {{ part.param2 }}
              <input type="hidden" name="parts[{{ loop.index0 }}][param2]" value="{{ part.param2 }}">
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>

      <button class="btn btn-primary">Save</button>
    </form>
  </div>

  <script>
    const tbody = document.getElementById('format-parts');
    let draggedRow = null;

    tbody.addEventListener('dragstart', e => {
      draggedRow = e.target.closest('tr');
      e.dataTransfer.effectAllowed = 'move';
    });

    tbody.addEventListener('dragover', e => {
      e.preventDefault();
      const targetRow = e.target.closest('tr');
      if (targetRow && targetRow !== draggedRow) {
        const rect = targetRow.getBoundingClientRect();
        const next = (e.clientY - rect.top) > rect.height / 2;
        tbody.insertBefore(draggedRow, next ? targetRow.nextSibling : targetRow);
      }
    });

    tbody.addEventListener('dragend', () => {
      [...tbody.children].forEach((row, index) => {
        row.querySelectorAll('input').forEach(input => {
          input.name = input.name.replace(/parts\[\d+]/, `parts[${index}]`);
        });
      });
    });
  </script>
{% endblock %}
